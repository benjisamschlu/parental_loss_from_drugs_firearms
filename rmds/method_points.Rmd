---
title: "Parental loss from drugs and firearms"
subtitle: "Methodological points"
author: "Ben Schl√ºter"
date: "2023-06-08"
toc: true
output: 
        pdf_document:
                extra_dependencies: ["float"]
bibliography: refs.bib
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, fig.pos = "H", out.extra = "")
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)

## Load packages ---------------------------------------------------------------

## Install/load packages
packages <- c("tidyverse", "ggplot2", "here", "viridis")
for(p in packages){
        if(!require(p,character.only = TRUE)) install.packages(p)
        library(p,character.only = TRUE)
}

```



# Matrix Kinship model

Kin: parents

-   Cause-specific (drugs, firearms, other) mortality [@Caswell2023]

    -   Track parents' deaths by age and cause

-   Two-sex: male fertility = shifted female fertility [@Schoumaker2019]

-   Time-variant rates (2000-2020)

Model run independently on each ethnic group 



# Notation for figures

* $\boldsymbol{F_t}$ is the $(\omega \cdot \omega)$ fertility matrix, in year $t$. The first row contains the fertility rates at the different ages.

* $\boldsymbol{\tilde{U_t}}$ is a block-matrix containing the survival probabilities (and cause-specific probabilities of dying), in year $t$.

* $\boldsymbol{n_t}$ is the vector of the population counts by age in year $t$. 

* $\omega$ is the highest age + 1, here 86.



# Visualization convention

```{r visu, warning=F, fig.cap="Arrays to visualize the parents projection"}
ggplot() +
    ## Arrays
    geom_rect(aes(xmin = 5, xmax = 20, ymin = 5, ymax = 15),
              color = "black", fill = NA) +
    geom_rect(aes(xmin = 10, xmax = 11, ymin = 5, ymax = 15),
              color = "black", fill = "cyan") +
    geom_rect(aes(xmin = 5, xmax = 6, ymin = 5, ymax = 15),
              color = "black", fill = "orange") +
    ## Annotation
    annotate("text", x = c(2, 12.5, 17), y = c(10, 17, 13), 
                 label = c("Parents age", "Child age", "Year t"),
                 size = 3,
             col = c("green", "blue", "black")) +
     annotate("text", x = 4, y = seq(14.5,9.5,-1), 
                 label = 0:5,
                 size = 3,
              col = "green") +
    annotate("text", x = seq(5.5,11.5, 1), y = 16, 
                 label = 0:6,
                 size = 3,
             col = "blue") +
    annotate("text", x = 8, y = 19, 
                 label = "Vector of the age distribution of parents (alive & dead by cause)\n at birth of their child in year t",
                 size = 3,
             col = "orange") +
    annotate("text", x = 15, y = 2, 
                 label = "Vector of the age distribution of parents (alive & dead by cause)\n at age 5 of their child in year t",
                 size = 3,
             col = "cyan") +
    ## Additional elements
    scale_x_continuous(breaks = seq(0, 25, 5), limits = c(0, 25)) +
    scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 20)) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank())
    
```


The model assumes that we randomly select a child in the population, hence this child could be any age in year $t$. This explains the different vectors of age distribution of parents over the ages of their child in year $t$.



# Starting the dynamic

Suppose the analysis focus on children aged <5 yo (in reality <18 yo but it simplifies the visualization).

```{r parents-proj, warning=F, fig.cap="Parents population projection"}
ggplot() +
    ## Cases
    annotate("text", x = c(12.5, 32.5), y = 110, 
                 label = c("Current situation", "Optimal situation"),
                 size = 4) +
    ## Arrays
    geom_rect(aes(xmin = 5, xmax = 20, ymin = seq(5,85,10), ymax = seq(15, 95, 10)),
              color = "black", fill = NA) +
    geom_rect(aes(xmin = 25, xmax = 40, ymin = seq(5,85,10), ymax = seq(15, 95, 10)),
              color = "black", fill = NA) +
    
    ## CURRENT CASE
    
    
    ## Cohort of vectors of parent 
    geom_rect(aes(xmin = 5:7, xmax = 6:8, ymin = seq(45, 25, -10), ymax = seq(55, 35, -10)),
                  color = "black", fill = "darkgray") +
    geom_rect(aes(xmin = 6, xmax = 7, ymin = 25, ymax = 35),
                  color = "black", fill = "purple") +
    geom_rect(aes(xmin = 7:8, xmax = 8:9, ymin = c(35, 25), ymax = c(45,35)),
                  color = "black", fill = "red") +
    geom_rect(aes(xmin = 8:9, xmax = 9:10, ymin = c(35, 25), ymax = c(45,35)),
                  color = "black", fill = "yellow") +
    annotate("text", x = seq(6, 19, 2), y = 61, 
                 label = rep(expression(tilde(U)[paste("2000")]), 7),
                 size = 2.5) +
    ## Stable assumption in 2000
    geom_rect(aes(xmin = 6:19, xmax = 7:20, ymin = 45, ymax = 55),
                  color = "black", fill = c("red", "yellow", rep(NA,12))) +
    geom_curve(aes(x = seq(5.5, 18.5, 1), y = 56, xend = seq(6.5, 19.5, 1), yend = 56),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -1) +
    ## Age of parents at birth of their child
    geom_rect(aes(xmin = 5, xmax = 6, ymin = seq(5,35,10), ymax = seq(15,45,10)),
                  color = "black", fill = c("orange", "green", "cyan", "purple")) +
    ## Progression of parent age distribution
    geom_curve(aes(x = seq(5.5, 6.5, 1), y = c(50,40), xend = seq(6.5, 7.5, 1), yend = c(40,30)),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -1, size = 0.8) +
    ## Age distribution of parents of offsping
    geom_curve(aes(x = 2, y = 25, xend = 5, yend = seq(50,10,-10)),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = 0) +
        annotate("text", x = -2, y = 25, 
                 label = expression(pi[t]*paste(" = ")*frac(F[t]^T*paste("(1,:)")%.%n[t], paste("|| ")*F[t]^T*paste("(1,:)")%.%n[t]*paste(" ||"))),
                 size = 3) +
    
    ## OPTIMAL CASE
    
    ## Cohort of vectors of parent 
    geom_rect(aes(xmin = 25:29, xmax = 26:30, ymin = seq(85, 45, -10), ymax = seq(95, 55, -10)),
                  color = "black", fill = "green") +
    geom_rect(aes(xmin = 25:29, xmax = 26:30, ymin = seq(75, 35, -10), ymax = seq(85, 45, -10)),
                  color = "black", fill = "orange") +
    geom_rect(aes(xmin = 25:28, xmax = 26:29, ymin = seq(65, 35, -10), ymax = seq(75, 45, -10)),
                  color = "black", fill = "cyan") +
    ## Stable pop assumption
    annotate("text", x = seq(26, 39, 2), y = 103, 
                 label = rep(expression(tilde(U)[paste("1996")]), 7),
                 size = 2.5) +
    geom_curve(aes(x = seq(25.5, 38.5, 1), y = 96, xend = seq(26.5, 39.5, 1), yend = 96),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -1) +
    geom_rect(aes(xmin = 25:39, xmax = 26:40, ymin = 85, ymax = 95),
                  color = "black", fill = "NA") +
    ## Year labels
    annotate("text", x = 19, y = c(12, seq(32, 92, 10)), 
                 label = paste(c(2020,2002:1996)),
                 size = 2.5) +
    annotate("text", x = 39, y = c(12, seq(32, 92, 10)), 
                 label = paste(c(2020,2002:1996)),
                 size = 2.5) +
    ## Points for year passing
    geom_point(aes(x = c(19), y = seq(17,23,2))) +
    geom_point(aes(x = c(39), y = seq(17,23,2))) +
    ## What we care about (ie <5 yo)
    geom_rect(aes(xmin = 5, xmax = 10, ymin = 5, ymax = 55),
              color = "pink", fill = NA, size = 1.5) +
    geom_rect(aes(xmin = 25, xmax = 30, ymin = 5, ymax = 55),
              color = "pink", fill = NA, size = 1.5) +
    annotate("text", x = 17.5, y = 1, 
                 label = "Age of child we care about (<5 yo)",
                 size = 3.5,
             col = "pink") +
    geom_curve(aes(x = c(11, 24), y = 2, xend = c(10,25), yend = 5),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = 0,
               size = 1,
               col = "pink") +
    ## U tilde projecting forward
    annotate("text", x = c(9.1, 10.1), y = c(45, 35), 
                 label = c(expression(tilde(U)[paste("2000")]), expression(tilde(U)[paste("2001")])),
                 size = 3) +
    ## Additional elements
    scale_x_continuous(breaks = seq(-5, 40, 5), limits = c(-5, 40)) +
    scale_y_continuous(breaks = seq(0, 110, 5), limits = c(0, 110)) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank())
    
```


The issue with the current case is that in the year 2000, the age distribution of parents for a child aged <5 yo might not correctly represents reality. This comes from assuming a stable population in that year to start the projection. This means that in order to obtain the vector of the age distribution of parents at age $x$ of their child in the year 2000, we assume

$$\boldsymbol{n_{x, t=2000}} = \boldsymbol{\tilde{U}}^x_{t=2000} \cdot \boldsymbol{\pi_{t=2000}}$$

where $\boldsymbol{\tilde{U}_{t=2000}}$ is raised to the power equal to the age of the child.

The optimal situation would be to start the dynamics in the year 1996 if we were to focus on children aged <5 yo (but in the year 1983 in reality as we focus on children aged <18 yo). This requires additional data that we currently don't have:

* Female fertility rates by age, and ethnic group for the years 1983-1999

    * Found for Black, White, and Hispanic if we perform some temporal intrapolation (brth1980_2000.xlsx)

* Population counts by age, sex, and ethnic group for the years 1983-1999

    * Only found for White and require to perform some temporal intrapolation (pop1980_2016.xlsx)

* All-causes deaths (to compute mortality rates) by age, sex and ethnic group for the years 1983-1999. This could be relaxed by obtaining estimated life expectancy at birth and converting it into survival probabilities using the Coale-Demeny Model West Life Tables [@verdery2017projections]

    * Before the year 2000, I will simplify the model to only look at parent surviving, not looking at parents dying from different causes. 




# Boundary conditions of the parents' dynamic

In Figure 1, color code is 

* \textcolor{orange}{boundary condition 1} 

* \textcolor{red}{boundary condition 2}

* \textcolor{darkgray}{dynamic of the age distribution of parents}

```{r bnd-cond, eval = F, warning=F, fig.cap="Boundary conditions of the parents' dynamic"}
ggplot() +
        ## Arrays
        geom_rect(aes(xmin = 45, xmax = 55, ymin = 45, ymax = 55),
                  color = "black", fill = NA) +
        geom_rect(aes(xmin = 29, xmax = 39, ymin = 29, ymax = 39),
                  color = "black", fill = NA) +
        geom_rect(aes(xmin = 17, xmax = 27, ymin = 17, ymax = 27),
                  color = "black", fill = NA) +
        geom_rect(aes(xmin = 5, xmax = 15, ymin = 5, ymax = 15),
                  color = "black", fill = NA) +
        ## Vector of age distribution of parents
        geom_rect(aes(xmin = c(5,17,29), xmax = c(6,18,30), ymin = c(5,17,29), ymax = c(15, 27, 39)),
                  color = "black", fill = "orange") +
        ## Boundary condition for the year 2000
        geom_rect(aes(xmin = seq(6, 14, 1), xmax = seq(7, 15, 1), ymin = 5, ymax = 15),
                  color = "black", fill = "red") +
        ## Meaning of vector
        geom_rect(aes(xmin = 20, xmax = 21, ymin = 17, ymax = 27),
                  color = "black", fill = "darkgray") +
        annotate("text", x = 30, y = 10, 
                 label = "Vector of age distribution of parents (alive & dead by cause)\n at age x+1 of their child in year t+1",
                 size = 2.5) +
        annotate("text", x = 7.5, y = 16, 
                 label = expression(d[x*paste(",")*t]),
                 size = 2.5) +
        annotate("text", x = 20.5, y = 28, 
                 label = expression(d[x+1*paste(",")*t+1]),
                 size = 2.5) +
        ## Evolution of vector
        geom_curve(aes(x = 7.5, y = 17, xend = 19.5, yend = 29),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -0.4) +
        geom_curve(aes(x = 20.5, y = 22, xend = 25, yend = 14),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = 0) +
        geom_rect(aes(xmin = 33, xmax = 34, ymin = 29, ymax = 39),
                  color = "black", fill = "darkgray") +
        annotate("text", x = 33.5, y = 41, 
                 label = expression(d[x+2*paste(",")*t+2]),
                 size = 2.5) +
        geom_curve(aes(x = 21, y = 29, xend = 33, yend = 42),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -0.4) +
        geom_curve(aes(x = 33.5, y = 43, xend = 42, yend = 43),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -0.4) +
        annotate("text", x = 10, y = 27, 
                 label = expression(d[x*paste(",")*t]%.%tilde(U)[paste("t")]),
                 size = 2.5) +
        annotate("text", x = 24, y = 42, 
                 label = expression(d[x+1*paste(",")*t+1]%.%tilde(U)[paste("t+1")]),
                 size = 2.5) +
        annotate("text", x = 37, y = 47, 
                 label = expression(d[x+2*paste(",")*t+2]%.%tilde(U)[paste("t+2")]),
                 size = 2.5) +
        geom_rect(aes(xmin = 52, xmax = 53, ymin = 45, ymax = 55),
                  color = "black", fill = "darkgray") +
        annotate("text", x = 45, y = 58, 
                 label = expression(d[x+(T-1)*paste(",")*T-1]%.%tilde(U)[paste("T-1")]),
                 size = 2.5) +
        geom_curve(aes(x = 43, y = 45, xend = 52, yend = 56),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = -0.4) +
        ## From one age to the next in boundary condition
        geom_curve(aes(x = seq(5.5, 13.5, 1), y = 4.5, xend = seq(6.5, 14.5, 1), yend = 4.5),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = 2, col = "red") +
        ## Age distribution of parents of offsprings
        geom_curve(aes(x = 8, y = 40, xend = c(5.5, 17.5, 29.5), yend = c(10,22,34)),
                   arrow = arrow(length = unit(0.01, "npc"),
                                 type = "closed"),
                   curvature = 0, col = "orange") +
        annotate("text", x = 5, y = 46, 
                 label = expression(pi[t]*paste(" = ")*frac(F[t]^T*paste("(1,:)")%.%n[t], paste("|| ")*F[t]^T*paste("(1,:)")%.%n[t]*paste(" ||"))),
                 size = 3,
                 col = "orange") +
        ## U_tilde matrix
        annotate("text", x = seq(6.5, 14.5, 2.5), y = 0, 
                 label = rep(expression(tilde(U)[paste("2000")]), 4),
                 size = 2.5,
                 col = "red") +
        ## Dim
        annotate("text", x = c(11.5, 1), y = c(17, 10), 
                 label = c("Child age", "Parents' age"),
                 color = c("cyan", "blue"),
                 size = 3) +
        ## Year dim
        annotate("text", x = c(12, 24, 36, 52), y = c(13, 25, 37, 53), 
                 label = c("year 2000", "year 2001", "year 2002", "year 2020"),
                 color = "green",
                 size = 3) +
        geom_point(aes(x = c(41:44), y = c(41:44))) +
        scale_x_continuous(breaks = seq(0, 60, 5), limits = c(0, 60)) +
        scale_y_continuous(breaks = seq(0, 60, 5), limits = c(0, 60)) +
        theme_minimal() +
        theme(axis.title = element_blank(),
              axis.text = element_blank())
```



## Boundary condition 2

In order to start the dynamics, we assume that the earliest vital rates have been operating for a long period before the year 2000. This means that in order to obtain the vector of the age distribution of parents at age $x$ of their child in the year 2000, we assume

$$\boldsymbol{n_{x, t=2000}} = \textcolor{red}{\boldsymbol{\tilde{U}}}^x_{\textcolor{red}{t=2000}} \cdot \boldsymbol{\pi_{t=2000}}$$

where $\textcolor{red}{\boldsymbol{\tilde{U}}_{t=2000}}$ is raised to the power equal to the age of the child.

This assumption might not correctly reflect the age distribution of parents at different age of their child (i.e different cohorts) in the year 2000.

Ideally, we would like to be able to correctly reflect any cohort of parent that could have a child aged less than 18 years old, in the year 2000 or after. Hence, the best would be to be able to start the dynamic in the year 1983. FIGURE?

* From the supplementary materials of @verdery2017projections

    * Use life expectancy for Black and White estimated by @national2016health for the period 1983-1999 and convert these into survival probabilities using the Coale-Demeny Model West Life Tables (or modeling methods?). This leads to focus on only two ethnic groups.
    
    * Found fertility data from CDC starting in 1950.
    
    * Need population counts by ethnic group from the year 1983



# Number of children losing a parent

* Found real number of births 2000-2015 Black & White non Hispanic (t5_birth_2015_1989.pdf)

* Found real number of births 2016-2020 all ethnic groups 2016-2020 t1_birth_2021_2016.pdf)



# Sensitivity

Focusing on parents means that fertility enters the model only through the first boundary condition: the age distribution of parents at the birth of their child (\textcolor{orange}{$\pi_t$}). 

Currently, the kin dynamics consists of a full two-sex model ($\boldsymbol{F^f_t}$ and $\boldsymbol{F^m_t}$). Male fertility rates = shifted female fertility rates. The shift is equal to the difference in the mean age at childbearing between the two sexes. The shifts are modeled with a linear model over the years (data from the UN Demographic Yearbook).\

* Sensitivity analysis: use female fertility rates to compute both female and male age distribution at the birth of their child.



# Uncertainty in estimates

We can simulate an i-th series of death counts for every combination of sex, ethnic group, year, and cause of death (other, drugs, firearms) at all ages using the Chiang method [@chiang1984life] as follows:

$${}_nD_{x,i} \sim Binomial(\frac{{}_nD_{x,i}}{{}_nq_{x}}, {}_nq_{x})$$
We repeat this procedure $N_{sim}$ times for each combination and obtain  $N_{sim}$ associated survival probabilities and cause-specific probabilities of dying that we can use as inputs in the matrix kinship model. 

This is similar to the UN WPP using Bayesian prosterior draws as inputs for the cohort-component model.  



# Parents are shared: overestimation?

Check assumption taken in paper


# Mx of Fx having the biggest impact for Black: K-K decomposition



# References


<div id="refs"></div>





